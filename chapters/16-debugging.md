# デバッグと調査（実務の型）

> 提出ブランチ：`feature/16-debugging`（PRのbase：`develop`）

実務で一番価値が出るのは「新機能」だけではなく、**壊れたものを直して、二度と壊れないようにする**力です。
この章では、Compose中心のアプリを前提に、実務で必要な「調査→修正→回帰防止」の型をまとめます。

---

## 前提

- [既存プロジェクト参画（読む・直す・壊さない）](./26-onboarding.md) を完了し、既存コードの追い方の型がある

## この章でできるようになること

- [ ] 不具合の再現手順を、最短手数で書ける
- [ ] スタックトレースを読んで、原因箇所の候補を絞れる
- [ ] Logcat/Debuggerで「仮説→検証」を回せる
- [ ] ネットワーク/DB/UIのどこが原因かを切り分けできる
- [ ] 修正後に、回帰防止（テスト or 仕組み）を追加できる

**所要時間の目安：2〜3時間**

---

## まず最初にやること（再現の型）

### 1) 事実を揃える

- 端末/OS（例：Pixel 7 / Android 14）
- ビルド種別（Debug/Release）
- アカウント状態（ログイン済み/未ログイン、初回起動か等）
- 発生頻度（毎回/時々/初回だけ）

### 2) 再現手順を書く（最短）

悪い例：  
「たまに落ちます」

良い例：  
「起動 → 一覧 → ＋ → タイトル未入力のまま保存 → 100%クラッシュ」

### 3) 期待結果を明確にする

「落ちない」では弱いです。例：

- タイトル未入力なら保存ボタンが押せない
- もしくはエラーメッセージを表示して保存しない

---

## スタックトレースの読み方（最短で当てる）

### 見る場所は3つだけ

1. **例外の種類**（`NullPointerException`, `IllegalStateException` など）
2. **一番上の自分のコード**（パッケージ名で判断）
3. **発生条件**（クリック、画面遷移、Flowの購読開始など）

### よくある例外と初手

- `NullPointerException`：nullableの取り扱い/非同期のタイミング/初期化漏れ
- `IllegalStateException`：状態とライフサイクルのズレ（画面遷移、StateFlowの購読）
- `JsonDataException` / parse系：APIレスポンスの想定違い（null/型違い）
- `SQLiteConstraintException`：主キー/ユニーク制約/マイグレーション

---

## Logcat（ログ）の出し方・読み方

ログは「出せばいい」ではなく、**調査のために設計**します。

### ログで知りたいこと（例）

- どの画面で、どのイベントが起きたか
- その時の入力値/状態（ただし個人情報やトークンは出さない）
- ネットワークの成否（ステータス、エラー種別）

### 実務で強いログの粒度

- 画面表示（screen）
- ユーザー操作（event）
- 失敗（error）

---

## Debugger（ブレークポイント）の使い所

ログで追えない「分岐の中身」や「状態遷移」を確認するときに使います。

おすすめ手順：

1. 例外の直前にブレークポイント
2. 入力値/State/Repositoryの戻りを確認
3. 仮説が立ったら、ログ or テストに落とす（再発防止）

---

## どこが悪いかを切り分ける（UI / VM / Data）

実務で重要なのは「最短で境界を当てる」ことです。

### UIが怪しいサイン

- 表示が更新されない/チラつく
- 入力と状態がズレる
- 再コンポーズの連鎖で固まる

### ViewModelが怪しいサイン

- 状態が一貫しない（Loadingのまま等）
- 連打で二重送信される
- イベント（Snackbar/Navigation）が二重発火する

### Data層が怪しいサイン

- タイムアウト/5xx/パース失敗
- キャッシュ/永続化の整合性が壊れる
- スレッド/Dispatcherの使い方が間違っている

---

## 使う道具（覚えると一生ラク）

### Network Inspector（通信の中身を見る）

- リクエスト/レスポンスが想定どおりか
- エラー時に何が返っているか
- リトライで同じ通信が連打されていないか

### Database Inspector / Room（DBの中身を見る）

- 保存できているか
- 期待した順序/条件で取れているか
- マイグレーション後にデータが壊れていないか

### Layout Inspector / Compose

- どのComposableが重い/頻繁に更新されているか
- 画面サイズや文字サイズで崩れていないか

### Profiler（最後の決定打）

- CPU：固まる/重い（メインスレッド詰まり）
- Memory：増え続ける（リーク/キャッシュ過多）
- Network：無駄な通信/サイズ過多

---

## 回帰防止の選択肢（テストだけじゃない）

修正のゴールは「今直った」ではなく「次に壊れない」です。

- ユニットテストで状態遷移を守る（最優先）
- 失敗しないUIに変える（ボタン無効化、二重送信ガード）
- 失敗を観測できるようにする（ログ/エラー種別の統一）
- 仕様の曖昧さを潰す（期待結果を明文化）

---

## 演習

### チケット：保存時にクラッシュする

**現象**：タイトル未入力で保存するとクラッシュ  
**期待**：保存しない + エラー表示（または保存ボタン無効）

**やること**

1. 最短の再現手順を書く
2. スタックトレースから原因候補を3つ挙げる
3. 1つずつ潰す（ログ or Debugger）
4. 修正（入力バリデーション/状態管理）
5. 回帰防止：ViewModelのユニットテストを1本追加

---

## チェックリスト（PRに書くと強い）

- [ ] 再現手順と期待結果
- [ ] 原因と、なぜそう言えるか（ログ/スタックトレース）
- [ ] 修正方針（境界・影響範囲・代替案）
- [ ] テスト（追加/実行結果）

---

## AIに聞いてみよう

### 質問テンプレ（コピペ）

```text
【前提】
この章を学習しています（この章のコンテキストは共有済み）。

【状況】
（例：クラッシュ / 画面が真っ白 / 表示が更新されない / 二重送信）

【今の材料】
- 再現手順：
- 期待結果：
- 実際の結果：
- ログ/スタックトレース：
- 最近の差分：

【欲しい回答】
- 原因候補（3つ）
- 切り分け手順（順番つき）
- 回帰防止策（テスト/ガード）
```

```text
【質問】
このスタックトレースを読んで、原因候補を3つ挙げて。
それぞれを切り分ける最短手順（ログ/ブレークポイント）も提案して。
```

---

## 課題提出

この章には提出課題があります。

1. 上記の演習を完了する
2. GitHub で `feature/16-debugging` ブランチを作成し、PRを作成
3. [AI総合レビューツール](https://ai.studio/apps/drive/1AMqIqU4Bio4te7AWh5dly1Qzp7CesqP9?fullscreenApplet=true) でレビューを実行
4. 問題がなければ、スプレッドシートに **PR URL** と **完了日** を記入

---

## ふりかえり

- 再現手順を書くとき、どこまで情報を揃えると速い？
- 切り分けの境界（UI/VM/Data）で、最初に疑うのはどこ？
- 次に同じ不具合が来たら、どの順番で調査する？

---

## 次の章

次は [チーム開発（Git/PR/コードレビュー）](./17-team-development.md) に進み、チーム開発（Git/PR/レビュー）の型を揃えましょう。
