# CIで品質を担保する（Gradle/テスト/Lint）

実務では「手元で動いた」は信用されません。CIで同じチェックを回し、**事故を仕組みで減らす**のが基本です。
この章では、Android（Compose/Hilt/REST）を想定したCIの最小セットを整理します。

---

## 前提

- [チーム開発（Git/PR/コードレビュー）](./17-team-development.md) を完了し、PR運用の型がある

## この章でできるようになること

- [ ] CIが何を守るための仕組みか説明できる
- [ ] Androidでよく回すチェック（テスト/Lint/ビルド）を理解する
- [ ] 失敗したときに、原因を切り分けて直せる
- [ ] PRに「CIの結果」を前提として書ける

**所要時間の目安：1〜2時間**

---

## CIで回す最小セット（おすすめ）

まずは「遅すぎない範囲」で、確実に価値が出るものだけ回します。

### 1) ユニットテスト

- `./gradlew testDebugUnitTest`

### 2) Lint

- `./gradlew lintDebug`

### 3) ビルド（少なくともDebug）

- `./gradlew assembleDebug`

プロジェクトによっては、`ktlint` や `detekt`、`dependencyUpdates` なども追加します。

---

## GitHub Actionsの最小例（参考）

実務でよく使う形です（プロジェクトに合わせて調整します）。

```yaml
name: android-ci
on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: gradle/actions/setup-gradle@v3
      - run: ./gradlew testDebugUnitTest lintDebug assembleDebug
```

UIテスト（`connectedAndroidTest`）はエミュレータ起動が必要で重いので、最初は別ジョブ/夜間実行に分けるのが現実的です。

---

## CIが落ちたときの直し方（型）

1. まずはログの「最初のエラー」を探す（後続は連鎖が多い）
2. ローカルで同じコマンドを叩いて再現する
3. 失敗の種類を分類する
   - コンパイルエラー
   - テスト失敗
   - Lint違反
   - 依存関係/Gradleの不整合
4. 修正したら、必ず同じコマンドで再実行して閉じる

---

## 失敗しやすいポイント（Androidあるある）

- Gradleのキャッシュ/環境差（JDK/SDK/NDK）
- 依存関係の解決（バージョン衝突）
- コルーチンのテストがflaky（時間依存）
- UIテストが環境依存（端末/エミュレータ差）

CIは「落ちないこと」より、「落ちた時に早く直せること」が重要です。

---

## 演習

- 自分のプロジェクトで「CIで回すべきコマンド」を3つ決める
- それぞれのコマンドが守る品質（何が壊れるのを防ぐか）を書けるようにする

---

## AIに聞いてみよう

### 質問テンプレ（コピペ）

```text
【前提】
この章を学習しています（この章のコンテキストは共有済み）。

【やりたいこと】
（例：CIを作りたい / 失敗原因を直したい / 速くしたい）

【今の状態】
- CIの設定（YAML）：
- 失敗ログ：
- 実行したいコマンド：

【欲しい回答】
- 原因候補と直し方
- 最小の設定例
- 事故りやすい点（キャッシュ/Secretsなど）
```

```text
【質問】
AndroidプロジェクトのCIで、最小構成で回すべきGradleタスクを提案して。
実行時間と検知できる不具合のバランスも説明して。
```

---

## 課題提出

この章には提出課題があります。

1. 上記の演習を完了する
2. GitHub で `feature/18-ci` ブランチを作成し、PRを作成
3. [AI総合レビューツール](https://ai.studio/apps/drive/1AMqIqU4Bio4te7AWh5dly1Qzp7CesqP9?fullscreenApplet=true) でレビューを実行
4. 問題がなければ、スプレッドシートに **PR URL** と **完了日** を記入

---

## ふりかえり

- CIで「最低限守りたい品質」は何？（ビルド/テスト/Lint）
- CIが落ちたとき、最初に見るべき場所はどこ？
- 実行時間が重いチェック（UIテスト等）を、どう運用で回す？

---

## 次の章

次は [Unit 9: ビルドとモジュール化（ガイド）](./09-unit9-guide.md) に進み、Gradle/モジュール化の全体像を確認しましょう。
