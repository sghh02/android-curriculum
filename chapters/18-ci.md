# CIで品質を担保する（Gradle/テスト/Lint）

実務では「手元で動いた」は信用されません。CIで同じチェックを回し、**事故を仕組みで減らす**のが基本です。
この章では、Android（Compose/Hilt/REST）を想定したCIの最小セットを整理します。

---

## この章の目標

- [ ] CIが何を守るための仕組みか説明できる
- [ ] Androidでよく回すチェック（テスト/Lint/ビルド）を理解する
- [ ] 失敗したときに、原因を切り分けて直せる
- [ ] PRに「CIの結果」を前提として書ける

**所要時間の目安：1〜2時間**

---

## CIで回す最小セット（おすすめ）

まずは「遅すぎない範囲」で、確実に価値が出るものだけ回します。

### 1) ユニットテスト

- `./gradlew testDebugUnitTest`

### 2) Lint

- `./gradlew lintDebug`

### 3) ビルド（少なくともDebug）

- `./gradlew assembleDebug`

プロジェクトによっては、`ktlint` や `detekt`、`dependencyUpdates` なども追加します。

---

## GitHub Actionsの最小例（参考）

実務でよく使う形です（プロジェクトに合わせて調整します）。

```yaml
name: android-ci
on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: gradle/actions/setup-gradle@v3
      - run: ./gradlew testDebugUnitTest lintDebug assembleDebug
```

UIテスト（`connectedAndroidTest`）はエミュレータ起動が必要で重いので、最初は別ジョブ/夜間実行に分けるのが現実的です。

---

## CIが落ちたときの直し方（型）

1. まずはログの「最初のエラー」を探す（後続は連鎖が多い）
2. ローカルで同じコマンドを叩いて再現する
3. 失敗の種類を分類する
   - コンパイルエラー
   - テスト失敗
   - Lint違反
   - 依存関係/Gradleの不整合
4. 修正したら、必ず同じコマンドで再実行して閉じる

---

## 失敗しやすいポイント（Androidあるある）

- Gradleのキャッシュ/環境差（JDK/SDK/NDK）
- 依存関係の解決（バージョン衝突）
- コルーチンのテストがflaky（時間依存）
- UIテストが環境依存（端末/エミュレータ差）

CIは「落ちないこと」より、「落ちた時に早く直せること」が重要です。

---

## ミニ課題

- 自分のプロジェクトで「CIで回すべきコマンド」を3つ決める
- それぞれのコマンドが守る品質（何が壊れるのを防ぐか）を書けるようにする

---

## AIに聞いてみよう

```
【質問】
AndroidプロジェクトのCIで、最小構成で回すべきGradleタスクを提案して。
実行時間と検知できる不具合のバランスも説明して。
```
