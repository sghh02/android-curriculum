# パフォーマンスと最適化

> 提出ブランチ：`feature/13-performance`（PRのbase：`main`）

実務では「たまに重い」「端末によってカクつく」「しばらく使うと落ちる」が一番つらいです。
この章では、Compose中心のアプリで **“どこを見て、どう直すか”** の型を身につけます。

---

## 前提

- [テスト（ユニット/Compose UI）](./12-testing.md) を完了し、計測→改善→回帰防止の考え方がある

## この章でできるようになること

- [ ] 体感の問題を「計測できる問題」に分解できる
- [ ] Composeの再コンポーズと状態の関係を説明できる
- [ ] 遅い/重い原因をProfilerで特定する手順がわかる
- [ ] LazyColumn/画像/ネットワークで起こりやすいボトルネックを潰せる
- [ ] 直したら必ず「再計測」して効果を確認できる

**所要時間の目安：1.5〜2.5時間**

---

## パフォーマンス改善の基本手順（型）

1. **症状を定義**する（いつ、どの画面で、何が遅いか）
2. **計測**する（CPU/メモリ/ネットワーク/フレーム）
3. **原因候補を絞る**（UI/非同期/DB/画像/アロケーション）
4. **最小の修正**で改善する
5. **再計測**して、改善と副作用（電池/メモリ）を確認する

“気合いで最適化”はしないのが実務の流儀です。

---

## Composeでよくある遅さの原因

### 1) 無駄な再コンポーズ

状態が変わるたびにComposableが再実行されます。問題は「必要以上に広い範囲が再描画される」ケースです。

**対策の方向性**

- 状態を持つ場所を絞る（State Hoisting）
- 重い計算は `remember` / `derivedStateOf` に逃がす
- リストは `key` を付け、行の再利用を安定させる

```kotlin
val filtered by remember(query, memos) {
    derivedStateOf { memos.filter { it.title.contains(query) } }
}
```

### 2) LazyColumnの落とし穴

- `items` に `key` がない
- 行の中で重い処理（整形/画像/DB）をしている
- `Modifier` の組み合わせで計測・レイアウトが増える

### 3) 画像表示が重い

- 画像のサイズが大きすぎる（デコードが重い）
- スクロール中に再読み込みが走る
- プレースホルダ/キャッシュ設計がない

（Coilのキャッシュ設定やプレースホルダはネットワーク章と合わせて確認します）

---

## 計測の道具（最低限）

### Android Studio Profiler

- **CPU**：メインスレッドが詰まっていないか
- **Memory**：増え続けていないか（リーク/キャッシュ過多）
- **Network**：無駄な再リクエストがないか

### Layout Inspector / Compose

- 再コンポーズが多い箇所を疑う
- 画面のどの要素が重いかを当てる

---

## 実務で効く改善ポイント（チェックリスト）

- [ ] メインスレッドで重い処理をしていない（パース/ソート/IO）
- [ ] `remember` を“保持すべき値”にだけ使っている（過剰に使わない）
- [ ] リストには `key` がある
- [ ] UI stateが巨大すぎない（不要な変更で全体が更新されない）
- [ ] リトライ/ポーリングで通信が暴れていない
- [ ] Roomのクエリが重くない（必要ならIndex/クエリ見直し）

---

## 演習

1. 1000件のデータを `LazyColumn` で表示し、スクロールの引っかかりを体感する
2. `key` を追加して差分を確認する
3. 行の中の重い処理を `remember` に逃がし、再コンポーズ時の負荷を落とす
4. Profilerで「改善した根拠」をメモする（スクショでもOK）

---

## AIに聞いてみよう

### 質問テンプレ（コピペ）

```text
【前提】
この章を学習しています（この章のコンテキストは共有済み）。

【やりたいこと】
（例：遅い原因を知りたい / 計測方法が知りたい / 改善案が欲しい）

【今の状態】
- 症状（どこが遅い/重い）：
- 端末/OS：
- 関連コード：

【欲しい回答】
- 計測の手順（Profilerなど）
- 原因候補と優先順位
- 改善案（安全な順）
```

```text
【質問】
このComposableが再コンポーズされすぎている気がする。
状態の持ち方と分割の方針を、根拠付きで提案して。
```

---

## 課題提出

この章には提出課題があります。

1. 上記の演習を完了する
2. GitHub で `feature/13-performance` ブランチを作成し、PRを作成
3. [AI総合レビューツール](https://ai.studio/apps/drive/1AMqIqU4Bio4te7AWh5dly1Qzp7CesqP9?fullscreenApplet=true) でレビューを実行
4. 問題がなければ、スプレッドシートに **PR URL** と **完了日** を記入

---

## ふりかえり

- 「計測なし最適化」が危険な理由は何？
- いまのアプリで、再コンポーズが多そうな場所はどこ？
- 改善の“根拠”を、どう残す？（スクショ/数値/手順）

---

## 次の章

次は [アプリ公開と運用](./14-publishing.md) に進み、リリース前後の運用を押さえましょう。
